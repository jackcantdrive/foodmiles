<!DOCTYPE html>
<html>
<head>
    <title>Paper Detection with Webcam</title>
    <!-- <script async src="https://docs.opencv.org/4.5.5/opencv.js"></script> -->
    <script async src="./opencv-4.5.5.js"></script>
    <style>
        video, canvas {
            display: block;
            margin: 0 auto;
        }
    </style>
</head>
<body>
    <h1>Paper Detection with Webcam</h1>
    <video id="video" width="640" height="480" autoplay></video>
    <canvas id="canvasOutput" width="640" height="480"></canvas>
    <script>
        // document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvasOutput');
    const context = canvas.getContext('2d');

    // Access the webcam
    navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
            video.srcObject = stream;
            video.play();
        })
        .catch(err => {
            console.error("Error accessing the webcam: " + err);
        });

    video.addEventListener('play', () => {
        const FPS = 30;
        let src = new cv.Mat(video.height, video.width, cv.CV_8UC4);
        let dst = new cv.Mat(video.height, video.width, cv.CV_8UC1);
        let cap = new cv.VideoCapture(video);

        function processVideo() {
            if (video.paused || video.ended) {
                src.delete();
                dst.delete();
                return;
            }

            cap.read(src);

            // Convert to grayscale
            cv.cvtColor(src, dst, cv.COLOR_RGBA2GRAY, 0);
            // Gaussian blur
            cv.GaussianBlur(dst, dst, new cv.Size(5, 5), 0, 0, cv.BORDER_DEFAULT);
            // Canny edge detection
            cv.Canny(dst, dst, 75, 200);

            // Find contours
            let contours = new cv.MatVector();
            let hierarchy = new cv.Mat();
            cv.findContours(dst, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

            // Find the largest contour, assuming it's the paper
            let largestContour = contours.get(0);
            for (let i = 1; i < contours.size(); ++i) {
                if (cv.contourArea(contours.get(i)) > cv.contourArea(largestContour)) {
                    largestContour = contours.get(i);
                }
            }

            // Approximate the contour to a polygon
            let approx = new cv.Mat();
            cv.approxPolyDP(largestContour, approx, 0.02 * cv.arcLength(largestContour, true), true);

            // Draw the polygon on the original image
            for (let i = 0; i < approx.rows; ++i) {
                let pt1 = new cv.Point(approx.data32S[i * 2], approx.data32S[i * 2 + 1]);
                let pt2 = new cv.Point(approx.data32S[(i * 2 + 2) % (approx.rows * 2)], approx.data32S[(i * 2 + 3) % (approx.rows * 2)]);
                cv.line(src, pt1, pt2, [255, 0, 0, 255], 4);
            }

            cv.imshow('canvasOutput', src);

            // Clean up
            contours.delete();
            hierarchy.delete();
            approx.delete();

            setTimeout(processVideo, 1000 / FPS);
        }

        processVideo();
    });
}, 1000);
    </script>
</body>
</html>
